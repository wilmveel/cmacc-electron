<link rel="import" href="../bower_components/cmacc-elements/cmacc-app.html">


<dom-module id="common-accord">
    <style>

    </style>

    <template>
        <paper-toast id="daemon" text="ipfs connected"></paper-toast>

        <cmacc-app ast="{{ast}}" files="{{files}}" base="{{currentDir}}" file="{{file}}"></cmacc-app>
    </template>

    <script>
        Polymer({
            is:'common-accord',
            properties:{
                currentDir:{
                    type:String
                },
                files:{
                    type:Array
                },
                ast:{
                    type:Object,
                    observer:'refresh'
                },
                file:{
                    type:String,
                    //observer:'watch'
                }
            },
            ready:function(){

                var ipc = require('electron').ipcRenderer;
                var path = require('path')



                this.addEventListener('cmacc-save', function(e){
                    ipc.send('common-accord-save')

                }.bind(this), true)




                ipc.on('new-document', function(e, args){


                    this.clean(function(){
                        this.currentDir = 'file://'+args.directory

                        let filez = [];
                        args.files.forEach(function(file){

                            var sub = path.basename(args.directory) + '/'+ path.relative(args.directory, file)
                            filez.push(sub)
                        })

                        this.set('files', filez)
                    }.bind(this))

                }.bind(this), true)

                ipc.on('open-document',function(e, args){
                    this.clean(function(){

                        require('fs').watch(args.directory, function(eventType, filename){
                            if(filename){
                                window.cmacc.compose(this.ast.file, null, function (err, ast) {

                                    this.ast = ast;
                                }.bind(this))
                            }
                        }.bind(this))

                        this.currentDir = 'file://'+args.directory
                        this.set('files',[(path.basename(args.directory) + '/'+ path.relative(args.directory, args.files))])

                    }.bind(this))

                }.bind(this), true)

                ipc.on('open-directory',function(e, args){


                    this.clean(function(){

                        require('fs').watch(args.directory, function(eventType, filename){
                            if(filename){
                                window.cmacc.compose(this.ast.file, null, function (err, ast) {

                                    this.ast = ast;
                                }.bind(this))
                            }
                        }.bind(this))

                        this.currentDir = 'file://'+args.directory

                        let filez = [];
                        args.files.forEach(function(file){

                            var sub = path.basename(args.directory) + '/'+ path.relative(args.directory, file)
                            filez.push(sub)
                        })

                        this.set('files', filez)
                    }.bind(this))
                }.bind(this), true)

                ipc.on('daemon-ready', function(e, args){
                    this.$.daemon.open();
                }.bind(this), true)

                ipc.on('save-current', function(e){

                    cmacc.serialize(this.ast, function(err, text){
                        console.log(this.file.substring(7))
                        console.log(text)
                        var dir = path.relative(path.dirname(location.pathname), this.file.substring(7))
                        require('fs').writeFile(dir,text , function(err){
                            console.log(err)
                        })
                    }.bind(this))
                }.bind(this), true)

                ipc.on('save-document', function(e, args){
                    //this.currentDir = args;
                    cmacc.serialize(this.ast, function(err, text){
                        util = require('util')
                        require('fs').writeFile(args,text, function(){

                        })
                    })
                }.bind(this), true)

                ipc.on('publish', function(){
                    ipc.send('ipfs-add', this.currentDir )

                }.bind(this), true)

            },
            refresh:function(){
                console.log('yeah',this.ast)
                document.title = "Common Accord Desktop - " + require('path').basename(this.ast.file)
            },
            clean: function(cb){
                console.log('THISAST', this.ast)
                if (this.ast !== undefined){
                    window.cmacc.compose(this.ast.file, null, function (err, ast) {

                        this.ast = ast;
                        console.log("THISAST2", this.ast)
                        cb()
                    }.bind(this))

                }
                else cb()


            },
//            watch: function(){
//                require('fs').watch(this.file.substring(7), function(eventType, filename){
//                    if(filename){
//                        window.cmacc.compose(this.ast.file, null, function (err, ast) {
//
//                            this.ast = ast;
//                        }.bind(this))
//                    }
//                }.bind(this))
//            }
        })
    </script>

</dom-module>