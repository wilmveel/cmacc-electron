<link rel="import" href="../bower_components/cmacc-elements/cmacc-app.html">


<dom-module id="common-accord">
    <style>

    </style>

    <template>
        <paper-toast id="daemon" text="ipfs connected"></paper-toast>

        <cmacc-app ast="{{ast}}" files="{{files}}" src="{{src}}" base="{{currentDir}}" file="{{file}}"></cmacc-app>
    </template>

    <script>
        Polymer({
            is: 'common-accord',
            properties: {
                currentDir: {
                    type: String
                },
                files: {
                    type: Array
                },
                ast: {
                    type: Object,
                    observer: 'refresh'
                },
                file: {
                    type: String,
                    //observer:'watch'
                },
                src:{
                    type:Object
                }

            },
            ready: function () {

                var ipc = require('electron').ipcRenderer;
                var path = require('path')

                this.addEventListener('cmacc-save', function (e) {
                    ipc.send('common-accord-save')
                }.bind(this), true)

                ipc.on('new-document', function (e, args) {


                    this.clean(function () {

                        this.currentDir = 'file://' + args.directory;

                        let filez = [];
                        args.files.forEach(function (file) {

                            var sub = path.relative(args.directory, file);
                            filez.push(sub)
                        });

                        this.set('files', filez);

                    }.bind(this))

                }.bind(this), true);

                ipc.on('open-document', function (e, args) {

                    this.clean(function () {

                        require('fs').watch(args.directory, function (eventType, filename) {
                            if (filename) {
                                window.cmacc.compose(this.file, null, function (err, ast) {
                                    console.log('HEEEEEE',ast)
                                    //this.ast = ast;
                                }.bind(this))
                            }
                        }.bind(this))


                        this.currentDir = 'file://' + args.directory
                        this.set('files', [path.relative(args.directory, args.files)])

                    }.bind(this))

                }.bind(this), true)

                ipc.on('open-directory', function (e, args) {

                    this.clean(function () {

                        require('fs').watch(args.directory, function (eventType, filename) {
                            if (filename) {
                                var tmpFile = this.file;
                                this.set('file', '');
                                this.set('file', tmpFile);
//                                window.cmacc.compile(this.file, null, function (err, ast) {
//
//                                    this.ast = ast;
//                                }.bind(this))
                            }
                        }.bind(this))

                        this.currentDir = 'file://' + args.directory

                        console.log('=-=-=-=-=-', args.directory, this.currentDir)
                        var filez = [];
                        args.files.forEach(function (file) {
                            console.log(file);

                            var sub = path.relative(args.directory, file)
                            filez.push(sub)
                        })

                        this.set('files', filez)
                    }.bind(this))
                }.bind(this), true)

                ipc.on('daemon-ready', function (e, args) {
                    this.$.daemon.open();
                }.bind(this), true)

                ipc.on('save-current', function (e) {
                    console.log(this.file.substring(7))
                    console.log('save---', this.src)
                    var file = this.file.substring(7);
                    require('fs').writeFile(file, this.src, function (err) {
                        console.log(err)
                    })
                }.bind(this), true)

                ipc.on('save-document', function (e, args) {
                    //this.currentDir = args;
                    cmacc.serialize(this.ast, function (err, text) {
                        util = require('util')
                        require('fs').writeFile(args, text, function () {

                        })
                    })
                }.bind(this), true)

                ipc.on('publish', function () {
                    ipc.send('ipfs-add', this.currentDir)

                }.bind(this), true)

            },
            refresh: function () {

                console.log('ASTAST', this.ast)

                console.log('source', this.src)
                console.log('file', this.file)

                document.title = "Common Accord Desktop - " + require('path').basename(this.file)
            },
            clean: function (cb) {
                if (this.ast !== undefined) {
                    window.cmacc.compose(this.file, null, function (err, ast) {
                        console.log('WHAAAAATAST', err, ast)
                        this.ast = ast;
                        cb()
                    }.bind(this))
                }
                else cb()


            },
//            watch: function(){
//                require('fs').watch(this.file.substring(7), function(eventType, filename){
//                    if(filename){
//                        window.cmacc.compose(this.ast.file, null, function (err, ast) {
//
//                            this.ast = ast;
//                        }.bind(this))
//                    }
//                }.bind(this))
//            }
        })
    </script>

</dom-module>